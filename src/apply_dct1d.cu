#include <cuda_runtime.h>
#include "apply_dct1d.hpp"
#include <time.h>
#include <stdlib.h>
#include <stdio.h>
#include <iostream>

/* 
Each thread computes exactly one output value.
The DCT coefficient at index [w][z][y][k]
in which k is the X-dimension coef index (DCT output position)
and w,z,y specify the location of the 1D slice (sub-vector) I'm transforming
*/

// BUFFER ORDER: WZYX
//__constant__ double BASIS13[13 * 13] = {
//1,1,1,1,1,1,1,1,1,1,1,1,1,1.4039,1.32231,1.16387,0.937797,0.657218,0.338443,-2.27423e-16,-0.338443,-0.657218,-0.937797,-1.16387,-1.32231,-1.4039,1.37312,1.05855,0.501487,-0.170465,-0.803365,-1.25222,-1.41421,-1.25222,-0.803365,-0.170465,0.501487,1.05855,1.37312,1.32231,0.657218,-0.338443,-1.16387,-1.4039,-0.937797,-2.59787e-16,0.937797,1.4039,1.16387,0.338443,-0.657218,-1.32231,1.25222,0.170465,-1.05855,-1.37312,-0.501487,0.803365,1.41421,0.803365,
//-0.501487,-1.37312,-1.05855,0.170465,1.25222,1.16387,-0.338443,-1.4039,-0.657218,0.937797,1.32231,4.32978e-16,-1.32231,-0.937797,0.657218,1.4039,0.338443,-1.16387,1.05855,-0.803365,-1.25222,0.501487,1.37312,-0.170465,-1.41421,-0.170465,1.37312,0.501487,-1.25222,-0.803365,1.05855,0.937797,-1.16387,-0.657218,1.32231,0.338443,-1.4039,-6.06169e-16,1.4039,-0.338443,-1.32231,0.657218,1.16387,-0.937797,0.803365,-1.37312,0.170465,1.25222,-1.05855,-0.501487,1.41421,-0.501487,-1.05855,1.25222,0.170465,-1.37312,0.803365,0.657218,-1.4039,0.937797,
//0.338443,-1.32231,1.16387,7.7936e-16,-1.16387,1.32231,-0.338443,-0.937797,1.4039,-0.657218,0.501487,-1.25222,1.37312,-0.803365,-0.170465,1.05855,-1.41421,1.05855,-0.170465,-0.803365,1.37312,-1.25222,0.501487,0.338443,-0.937797,1.32231,-1.4039,1.16387,-0.657218,1.5596e-15,0.657218,-1.16387,1.4039,-1.32231,0.937797,-0.338443,0.170465,-0.501487,0.803365,-1.05855,1.25222,-1.37312,1.41421,-1.37312,1.25222,-1.05855,0.803365,-0.501487,0.170465,};

//__constant__ double BASIS16[16 * 16] = {
//1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1.4074,1.35332,1.24723,1.0932,0.897168,0.666656,0.410525,0.138617,-0.138617,-0.410525,-0.666656,-0.897168,-1.0932,-1.24723,-1.35332,-1.4074,1.38704,1.17588,0.785695,0.275899,-0.275899,-0.785695,-1.17588,-1.38704,-1.38704,-1.17588,-0.785695,-0.275899,0.275899,0.785695,1.17588,1.38704,1.35332,0.897168,0.138617,-0.666656,-1.24723,-1.4074,-1.0932,-0.410525,0.410525,1.0932,1.4074,1.24723,
//0.666656,-0.138617,-0.897168,-1.35332,1.30656,0.541196,-0.541196,-1.30656,-1.30656,-0.541196,0.541196,1.30656,1.30656,0.541196,-0.541196,-1.30656,-1.30656,-0.541196,0.541196,1.30656,1.24723,0.138617,-1.0932,-1.35332,-0.410525,0.897168,1.4074,0.666656,-0.666656,-1.4074,-0.897168,0.410525,1.35332,1.0932,-0.138617,-1.24723,1.17588,-0.275899,-1.38704,-0.785695,0.785695,1.38704,0.275899,-1.17588,-1.17588,0.275899,1.38704,0.785695,-0.785695,-1.38704,-0.275899,1.17588,1.0932,-0.666656,-1.35332,0.138617,1.4074,0.410525,-1.24723,-0.897168,
//0.897168,1.24723,-0.410525,-1.4074,-0.138617,1.35332,0.666656,-1.0932,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,0.897168,-1.24723,-0.410525,1.4074,-0.138617,-1.35332,0.666656,1.0932,-1.0932,-0.666656,1.35332,0.138617,-1.4074,0.410525,1.24723,-0.897168,0.785695,-1.38704,0.275899,1.17588,-1.17588,-0.275899,1.38704,-0.785695,-0.785695,1.38704,-0.275899,-1.17588,1.17588,0.275899,-1.38704,0.785695,0.666656,-1.4074,0.897168,0.410525,
//-1.35332,1.0932,0.138617,-1.24723,1.24723,-0.138617,-1.0932,1.35332,-0.410525,-0.897168,1.4074,-0.666656,0.541196,-1.30656,1.30656,-0.541196,-0.541196,1.30656,-1.30656,0.541196,0.541196,-1.30656,1.30656,-0.541196,-0.541196,1.30656,-1.30656,0.541196,0.410525,-1.0932,1.4074,-1.24723,0.666656,0.138617,-0.897168,1.35332,-1.35332,0.897168,-0.138617,-0.666656,1.24723,-1.4074,1.0932,-0.410525,0.275899,-0.785695,1.17588,-1.38704,1.38704,-1.17588,0.785695,-0.275899,-0.275899,0.785695,-1.17588,1.38704,-1.38704,1.17588,-0.785695,0.275899,
//0.138617,-0.410525,0.666656,-0.897168,1.0932,-1.24723,1.35332,-1.4074,1.4074,-1.35332,1.24723,-1.0932,0.897168,-0.666656,0.410525,-0.138617,};

__constant__ double BASIS13[13 * 13] = {
1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,
1.40390235323759338,1.32231265144484689,1.16387494476104925,0.93779705680103165,0.65721781265334278,0.33844345812379117,-0.00000000000000023,-0.33844345812379040,-0.65721781265334267,-0.93779705680103120,-1.16387494476104925,-1.32231265144484689,-1.40390235323759338,
1.37311908647910430,1.05855405164560357,0.50148704053933324,-0.17046460798050689,-0.80336486913323779,-1.25222392036374819,-1.41421356237309515,-1.25222392036374908,-0.80336486913323812,-0.17046460798050786,0.50148704053933324,1.05855405164560312,1.37311908647910430,
1.32231265144484689,0.65721781265334278,-0.33844345812379040,-1.16387494476104925,-1.40390235323759338,-0.93779705680103143,-0.00000000000000026,0.93779705680103143,1.40390235323759338,1.16387494476104969,0.33844345812379090,-0.65721781265334178,-1.32231265144484667,
1.25222392036374863,0.17046460798050705,-1.05855405164560379,-1.37311908647910452,-0.50148704053933368,0.80336486913323646,1.41421356237309515,0.80336486913323912,-0.50148704053933302,-1.37311908647910408,-1.05855405164560379,0.17046460798050575,1.25222392036374863,
1.16387494476104925,-0.33844345812379040,-1.40390235323759338,-0.65721781265334345,0.93779705680103143,1.32231265144484689,0.00000000000000043,-1.32231265144484667,-0.93779705680103220,0.65721781265334167,1.40390235323759316,0.33844345812379001,-1.16387494476104836,
1.05855405164560357,-0.80336486913323779,-1.25222392036374908,0.50148704053933324,1.37311908647910452,-0.17046460798050719,-1.41421356237309515,-0.17046460798050697,1.37311908647910408,0.50148704053933413,-1.25222392036374863,-0.80336486913323968,1.05855405164560268,
0.93779705680103165,-1.16387494476104925,-0.65721781265334345,1.32231265144484689,0.33844345812379090,-1.40390235323759338,-0.00000000000000061,1.40390235323759316,-0.33844345812378851,-1.32231265144484711,0.65721781265334134,1.16387494476105080,-0.93779705680102898,
0.80336486913323812,-1.37311908647910430,0.17046460798050733,1.25222392036374908,-1.05855405164560290,-0.50148704053933635,1.41421356237309515,-0.50148704053933035,-1.05855405164560379,1.25222392036374730,0.17046460798050747,-1.37311908647910497,0.80336486913323779,
0.65721781265334278,-1.40390235323759338,0.93779705680103143,0.33844345812379090,-1.32231265144484711,1.16387494476104991,0.00000000000000078,-1.16387494476105080,1.32231265144484644,-0.33844345812379062,-0.93779705680103087,1.40390235323759294,-0.65721781265334078,
0.50148704053933324,-1.25222392036374908,1.37311908647910430,-0.80336486913323635,-0.17046460798050697,1.05855405164560379,-1.41421356237309515,1.05855405164560268,-0.17046460798050525,-0.80336486913324001,1.37311908647910386,-1.25222392036374930,0.50148704053932958,
0.33844345812379117,-0.93779705680103143,1.32231265144484689,-1.40390235323759338,1.16387494476104991,-0.65721781265334367,0.00000000000000156,0.65721781265334756,-1.16387494476104814,1.40390235323759338,-1.32231265144484644,0.93779705680103242,-0.33844345812379484,
0.17046460798050705,-0.50148704053933368,0.80336486913323912,-1.05855405164560379,1.25222392036374930,-1.37311908647910430,1.41421356237309515,-1.37311908647910452,1.25222392036374708,-1.05855405164560223,0.80336486913323746,-0.50148704053932947,0.17046460798050439,
};

__constant__ double BASIS16[16 * 16] = {
1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,1.00000000000000000,
1.40740373752638259,1.35331800117435264,1.24722501298667132,1.09320186700175759,0.89716758634263638,0.66665565847774677,0.41052452752235735,0.13861716919909170,-0.13861716919909153,-0.41052452752235713,-0.66665565847774666,-0.89716758634263616,-1.09320186700175759,-1.24722501298667110,-1.35331800117435264,-1.40740373752638237,
1.38703984532214752,1.17587560241935885,0.78569495838710235,0.27589937928294311,-0.27589937928294295,-0.78569495838710190,-1.17587560241935885,-1.38703984532214752,-1.38703984532214752,-1.17587560241935907,-0.78569495838710213,-0.27589937928294361,0.27589937928294306,0.78569495838710168,1.17587560241935885,1.38703984532214730,
1.35331800117435264,0.89716758634263638,0.13861716919909170,-0.66665565847774666,-1.24722501298667110,-1.40740373752638259,-1.09320186700175781,-0.41052452752235752,0.41052452752235696,1.09320186700175714,1.40740373752638259,1.24722501298667132,0.66665565847774699,-0.13861716919909056,-0.89716758634263538,-1.35331800117435219,
1.30656296487637658,0.54119610014619712,-0.54119610014619701,-1.30656296487637658,-1.30656296487637680,-0.54119610014619779,0.54119610014619735,1.30656296487637635,1.30656296487637658,0.54119610014619801,-0.54119610014619723,-1.30656296487637613,-1.30656296487637658,-0.54119610014619812,0.54119610014619701,1.30656296487637613,
1.24722501298667132,0.13861716919909170,-1.09320186700175759,-1.35331800117435286,-0.41052452752235752,0.89716758634263649,1.40740373752638259,0.66665565847774699,-0.66665565847774633,-1.40740373752638259,-0.89716758634263616,0.41052452752235785,1.35331800117435219,1.09320186700175848,-0.13861716919909023,-1.24722501298667088,
1.17587560241935885,-0.27589937928294295,-1.38703984532214752,-0.78569495838710213,0.78569495838710168,1.38703984532214752,0.27589937928294372,-1.17587560241935862,-1.17587560241935929,0.27589937928294150,1.38703984532214752,0.78569495838710268,-0.78569495838710124,-1.38703984532214775,-0.27589937928294550,1.17587560241935707,
1.09320186700175759,-0.66665565847774666,-1.35331800117435286,0.13861716919909076,1.40740373752638259,0.41052452752235769,-1.24722501298667110,-0.89716758634263616,0.89716758634263527,1.24722501298667177,-0.41052452752235769,-1.40740373752638259,-0.13861716919909445,1.35331800117435286,0.66665565847774766,-1.09320186700175581,
1.00000000000000022,-1.00000000000000000,-1.00000000000000022,0.99999999999999978,1.00000000000000022,-0.99999999999999889,-0.99999999999999956,0.99999999999999878,0.99999999999999967,-0.99999999999999856,-0.99999999999999978,0.99999999999999845,1.00000000000000000,-0.99999999999999845,-1.00000000000000022,0.99999999999999822,
0.89716758634263638,-1.24722501298667110,-0.41052452752235752,1.40740373752638259,-0.13861716919909056,-1.35331800117435264,0.66665565847774610,1.09320186700175848,-1.09320186700175759,-0.66665565847774744,1.35331800117435286,0.13861716919909461,-1.40740373752638281,0.41052452752235719,1.24722501298667310,-0.89716758634263460,
0.78569495838710235,-1.38703984532214752,0.27589937928294306,1.17587560241935907,-1.17587560241935862,-0.27589937928294267,1.38703984532214775,-0.78569495838710124,-0.78569495838710279,1.38703984532214752,-0.27589937928294345,-1.17587560241935840,1.17587560241935685,0.27589937928294600,-1.38703984532214797,0.78569495838710057,
0.66665565847774677,-1.40740373752638259,0.89716758634263649,0.41052452752235769,-1.35331800117435264,1.09320186700175759,0.13861716919909176,-1.24722501298667288,1.24722501298667199,-0.13861716919909237,-1.09320186700175737,1.35331800117435264,-0.41052452752235702,-0.89716758634263694,1.40740373752638237,-0.66665565847774066,
0.54119610014619712,-1.30656296487637680,1.30656296487637635,-0.54119610014619723,-0.54119610014619812,1.30656296487637658,-1.30656296487637613,0.54119610014619668,0.54119610014619857,-1.30656296487637791,1.30656296487637680,-0.54119610014619624,-0.54119610014619912,1.30656296487637791,-1.30656296487637480,0.54119610014619102,
0.41052452752235735,-1.09320186700175781,1.40740373752638259,-1.24722501298667110,0.66665565847774610,0.13861716919909176,-0.89716758634263649,1.35331800117435352,-1.35331800117435286,0.89716758634263472,-0.13861716919909203,-0.66665565847774810,1.24722501298667332,-1.40740373752638237,1.09320186700175515,-0.41052452752235152,
0.27589937928294311,-0.78569495838710213,1.17587560241935907,-1.38703984532214775,1.38703984532214752,-1.17587560241935840,0.78569495838710124,-0.27589937928294345,-0.27589937928294583,0.78569495838710313,-1.17587560241935840,1.38703984532214819,-1.38703984532214641,1.17587560241935929,-0.78569495838710013,0.27589937928293734,
0.13861716919909170,-0.41052452752235752,0.66665565847774699,-0.89716758634263616,1.09320186700175848,-1.24722501298667288,1.35331800117435352,-1.40740373752638281,1.40740373752638237,-1.35331800117435264,1.24722501298667177,-1.09320186700175848,0.89716758634263416,-0.66665565847774033,0.41052452752235619,-0.13861716919908601,
};

__global__ void dct4d_x_kernel(const double* d_input, double* d_output,
                             int W, int Z, int Y, int X)
{
    // calculates one output value
    int global_idx = blockIdx.x * blockDim.x + threadIdx.x;

    int X_stride = 1;         // stride between elements along X
    int Y_stride = X;         // stride between elements along Y
    int Z_stride = Y * X;     // stride between elements along Z
    int W_stride = Z * Y * X; // stride between elements along W

    int k = global_idx % X;
    int y = (global_idx / X) % Y;
    int z = (global_idx / (X * Y)) % Z;
    int w = global_idx / (X * Y * Z);

    
    // ensure this thread is within the bounds of the output data.
    if (w >= W || z >= Z || y >= Y || k >= X) {
        return;
    }

    // this thread calculates output[w][z][y][k]
    double sum = 0;

    for (int n = 0; n < X; ++n) {
        // calculate the linear index for the input element input[w][z][y][n]
        int input_linear_idx = 
              w * W_stride 
            + z * Z_stride 
            + y * Y_stride  // if dim was Y, n would walk here
            + n * X_stride; // n walks here

        // accumulate the sum
        sum += d_input[input_linear_idx] * BASIS13[X * k + n];
    }

    // calculate the linear index for the output element output[w][z][y][k]
    int output_linear_idx = 
          w * W_stride 
        + z * Z_stride 
        + y * Y_stride 
        + k * X_stride;

    d_output[output_linear_idx] = sum;
}

__global__ void dct4d_y_kernel(const double* d_input, double* d_output,
                               int W, int Z, int Y, int X) 
{
    int global_idx = blockIdx.x * blockDim.x + threadIdx.x;

    int X_stride = 1;
    int Y_stride = X;
    int Z_stride = Y * X;
    int W_stride = Y * X * Z;

    int x = global_idx % X;
    int k = (global_idx / X) % Y;
    int z = (global_idx / (X * Y)) % Z;
    int w = (global_idx / (X * Y * Z));

    // ensure this thread is within the bounds of the output data.
    if (w >= W || z >= Z || k >= Y || x >= X) {
        return;
    }

    // calculate dct sum
    // this thread calculates output[w][z][y][k]
    double sum = 0;

    /*
    ----------------- REMINDER ---------------
    for a given k, it takes its correct sum from the kth wave,
    so it doesnt walk through the whole slice, just one coef
    */
    for (int n = 0; n < Y; ++n) {
        // Calculate the linear index for the input element input[w][z][y][n]
        int input_linear_idx = 
              w * W_stride 
            + z * Z_stride 
            + n * Y_stride  // if dim was Y, n would walk here
            + x * X_stride; // n walks here

        // accumulate the sum
        sum += d_input[input_linear_idx] * BASIS13[Y * k + n];
    }


    // calculate the linear index for the output element output[w][z][y][k]
    // this is the same as the global_idx if the grid/block structure matches perfectly.
    // it just flattens again
    int output_linear_idx = 
          w * W_stride 
        + z * Z_stride 
        + k * Y_stride 
        + x * X_stride;

    // the output element is the position of the DCT basis wave coef at thread's WZY
    d_output[output_linear_idx] = sum;
}

__global__ void dct4d_z_kernel(const double* d_input, double* d_output,
    int W, int Z, int Y, int X) 
{
    int global_idx = blockIdx.x * blockDim.x + threadIdx.x;

    int X_stride = 1;
    int Y_stride = X;
    int Z_stride = Y * X;
    int W_stride = Y * X * Z;

    int x = global_idx % X;
    int y = (global_idx / X) % Y;
    int k = (global_idx / (X * Y)) % Z;
    int w = (global_idx / (X * Y * Z));

    // ensure this thread is within the bounds of the output data.
    if (w >= W || k >= Z || y >= Y || x >= X) {
        return;
    }

    // calculate dct sum
    // this thread calculates output[w][z][y][k]
    double sum = 0;

    /*
    for a given k, it takes its correct sum from the kth wave,
    so it doesnt walk through the whole slice, just one coef
    */
    for (int n = 0; n < Z; ++n) {
        // Calculate the linear index for the input element input[w][z][y][n]
        int input_linear_idx = 
        w * W_stride 
        + n * Z_stride 
        + y * Y_stride  // if dim was Y, n would walk here
        + x * X_stride;

        // accumulate the sum
        sum += d_input[input_linear_idx] * BASIS16[Z * k + n];
    }

    // calculate the linear index for the output element output[w][z][y][k]
    // this is the same as the global_idx if the grid/block structure matches perfectly.
    // it just flattens again
    int output_linear_idx = 
    w * W_stride 
    + k * Z_stride 
    + y * Y_stride 
    + x * X_stride;

    double normalizer = 1.3919410907075054;

    // the output element is the position of the DCT basis wave coef at thread's WZY
    d_output[output_linear_idx] = sum * normalizer;
}

// Struct for debug info
struct DctDebugInfo {
    int thread_k;
    double operands[32]; // adjust size as needed
    double basis[32];
    double products[32];
    int n_count;
    double sum;
};

__global__ void dct4d_w_kernel(const double* d_input, double* d_output,
    int W, int Z, int Y, int X, DctDebugInfo* debug_buffer) 
{
    int global_idx = blockIdx.x * blockDim.x + threadIdx.x;

    int X_stride = 1;
    int Y_stride = X;
    int Z_stride = Y * X;
    int W_stride = Y * X * Z;

    int x = global_idx % X;
    int y = (global_idx / X) % Y;
    int z = (global_idx / (X * Y)) % Z;
    int k = (global_idx / (X * Y * Z));

    // ensure this thread is within the bounds of the output data.
    if (k >= W || z >= Z || y >= Y || x >= X) {
        return;
    }
    // calculate dct sum
    // this thread calculates output[w][z][y][k]
    double sum = 0;

    // Only collect debug info for [:][0][0][0] (z==0, y==0, x==0)
    DctDebugInfo local_debug;
    bool do_debug = (z == 0 && y == 0 && x == 0 && debug_buffer != nullptr);
    if (do_debug) {
        local_debug.thread_k = k;
        local_debug.n_count = W;
    }

    for (int n = 0; n < W; ++n) {
        int input_linear_idx = 
            n * W_stride 
            + z * Z_stride 
            + y * Y_stride
            + x * X_stride;
        double op = d_input[input_linear_idx];
        double basis = BASIS16[W * k + n];
        double prod = op * basis;
        sum += prod;
        if (do_debug && n < 32) {
            local_debug.operands[n] = op;
            local_debug.basis[n] = basis;
            local_debug.products[n] = prod;
        }
    }
    if (do_debug) {
        local_debug.sum = sum * 1.3919410907075054;
        debug_buffer[k] = local_debug; // one slot per k
    }

    int output_linear_idx = 
        k * W_stride 
        + z * Z_stride 
        + y * Y_stride 
        + x * X_stride;

    double normalizer = 1.3919410907075054;
    d_output[output_linear_idx] = sum * normalizer;
}

void apply_dct1d_gpu(double* data,
                     int U, int V, int S, int T, int selectedDim) {
    double *d_output, *d_data;

    size_t size_out = (size_t)U*V*S*T * sizeof(double);
    size_t size_data = (size_t)U*V*S*T * sizeof(double);

    cudaMalloc(&d_output, size_out);
    cudaMalloc(&d_data, size_data);

    cudaMemcpy(d_data, data, size_data, cudaMemcpyHostToDevice);

    int total_threads = U * V * S * T;
    int threads_per_block = 256;

    dim3 num_blocks((total_threads + threads_per_block - 1) / threads_per_block);
    dim3 block_dims(threads_per_block);


    // Debug buffer for dct4d_w_kernel
    DctDebugInfo* d_debug = nullptr;
    DctDebugInfo* h_debug = nullptr;
    if (selectedDim == 0) {
        size_t debug_size = U * sizeof(DctDebugInfo); // one per k (U)
        cudaMalloc(&d_debug, debug_size);
        h_debug = (DctDebugInfo*)malloc(debug_size);
        cudaMemset(d_debug, 0, debug_size);
    }

    switch (selectedDim) {
        case 3: {
            dct4d_x_kernel<<<num_blocks, block_dims>>>(d_data, d_output, U, V, S, T);
            break;
        }
        case 2: {
            dct4d_y_kernel<<<num_blocks, block_dims>>>(d_data, d_output, U, V, S, T);
            break;
        }
        case 1: {
            dct4d_z_kernel<<<num_blocks, block_dims>>>(d_data, d_output, U, V, S, T);
            break;
        }
        case 0: {
            dct4d_w_kernel<<<num_blocks, block_dims>>>(d_data, d_output, U, V, S, T, d_debug);
            break;
        }
    }


    cudaError_t err = cudaGetLastError();
    if (err != cudaSuccess) {
        printf("CUDA Error after kernel launch: %s\n", cudaGetErrorString(err));
    }

    cudaMemcpy(data, d_output, size_out, cudaMemcpyDeviceToHost);
    err = cudaGetLastError();
    if (err != cudaSuccess) {
        printf("CUDA Error after memcpy: %s\n", cudaGetErrorString(err));
    }

    // Copy and print debug info if needed
    if (selectedDim == 0 && h_debug && d_debug) {
        size_t debug_size = U * sizeof(DctDebugInfo);
        cudaMemcpy(h_debug, d_debug, debug_size, cudaMemcpyDeviceToHost);
        for (int k = 0; k < U; ++k) {
            DctDebugInfo& dbg = h_debug[k];
            printf(">> Thread k=%d\n", dbg.thread_k);
            for (int n = 0; n < dbg.n_count && n < 32; ++n) {
                std::cout << "  operand[" << n << "]=" << std::setprecision(6) << dbg.operands[n]
                          << " * basis=" << std::setprecision(std::numeric_limits<double>::max_digits10) << dbg.basis[n]
                          << " = " << std::setprecision(std::numeric_limits<double>::max_digits10) << dbg.products[n] << std::endl;
            }

            std::cout << "  sum = " << std::setprecision(std::numeric_limits<double>::max_digits10) << dbg.sum << std::endl;
        }
    }

    if (d_debug) cudaFree(d_debug);
    if (h_debug) free(h_debug);

    cudaFree(d_output);
    cudaFree(d_data);
}
